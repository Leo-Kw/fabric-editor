<script lang="ts">
  import { fabric } from 'fabric'
  import Pen from './components/pen.svelte'
  import type { ControlPanelStore } from '../../store'

  export let canvas: fabric.Canvas
  export let workspace: fabric.Rect
  export let history: { version: string; objects: Object[] }[]
  export let store: ControlPanelStore

  let penWidth: number
  let showBrushMarks: boolean = true

  // type EventType = 'pen' | 'eraser' | ''

  // let eventType: EventType = ''
  // const componentObj = {
  //   '': undefined,
  //   pen: Pen,
  // }

  // $: component = componentObj[eventType]

  const bigger = () => {
    let zoomRatio = canvas.getZoom()
    zoomRatio += 0.02
    const center = canvas.getCenter()
    canvas.zoomToPoint(new fabric.Point(center.left, center.top), zoomRatio)
  }

  const smaller = () => {
    let zoomRatio = canvas.getZoom()
    zoomRatio > 1 && (zoomRatio -= 0.02)
    const center = canvas.getCenter()
    canvas.zoomToPoint(new fabric.Point(center.left, center.top), zoomRatio)
  }

  const reduction = () => {
    restoreSize()
    canvas.getObjects().forEach(function (obj) {
      if (obj instanceof fabric.Path) {
        canvas.remove(obj)
      }
    })
  }

  const restoreSize = () => {
    const objCenter = workspace.getCenterPoint()
    const viewportTransform = canvas.viewportTransform
    if (canvas.width === undefined || canvas.height === undefined || !viewportTransform) return
    viewportTransform[4] = canvas.width / 2 - objCenter.x * viewportTransform[0]
    viewportTransform[5] = canvas.height / 2 - objCenter.y * viewportTransform[3]
    canvas.setViewportTransform(viewportTransform)
    const center = canvas.getCenter()
    canvas.zoomToPoint(new fabric.Point(center.left, center.top), 1)
    canvas.freeDrawingBrush.width = penWidth ?? 1
    canvas.renderAll()
  }

  // const changeType = (e: EventType) => {
  //   eventType = eventType === e ? '' : e
  // }

  const changePenSize = (size: number) => {
    let zoomRatio = canvas.getZoom()
    canvas.isDrawingMode = true
    canvas.freeDrawingBrush.width = size / zoomRatio
    penWidth = size
  }

  const undo = () => {
    // let value
    // store.history.subscribe((v) => {
    //   v.pop()
    //   value = v.pop()
    // })
    // console.log(value)
    const item = history.pop()
    console.log(history)
    canvas.loadFromJSON(item, canvas.renderAll.bind(canvas))
    canvas.renderAll()
  }

  const show = () => {
    canvas.getObjects().forEach(function (obj) {
      if (obj instanceof fabric.Path) {
        obj.visible = showBrushMarks ? false : true
      }
    })
    showBrushMarks = !showBrushMarks
    canvas.renderAll()
  }

  const exportData = () => {
    // restoreSize()
    const dataUrl = canvas.toDataURL({
      format: 'png',
      quality: 1,
      width: 800,
      height: 600,
    })

    console.log(dataUrl)
  }
</script>

<div class="control-wrapper">
  <button on:click={exportData}>export</button>

  <svg
    on:click={undo}
    viewBox="0 0 1024 1024"
    version="1.1"
    xmlns="http://www.w3.org/2000/svg"
    width="14"
    height="14"
    ><path
      d="M223.300267 221.320533h410.555733c214.493867 0 388.437333 173.192533 388.437333 386.798934 0 213.674667-173.943467 386.8672-388.437333 386.8672H116.053333a64.580267 64.580267 0 0 1-64.7168-64.512c0-35.566933 29.013333-64.443733 64.7168-64.443734h517.802667a258.389333 258.389333 0 0 0 258.935467-257.911466 258.389333 258.389333 0 0 0-258.935467-257.8432h-415.061333L293.546667 424.823467a64.3072 64.3072 0 0 1-28.672 108.7488 64.853333 64.853333 0 0 1-62.941867-17.6128L19.114667 333.687467a64.375467 64.375467 0 0 1 0-91.204267L201.9328 60.074667a64.9216 64.9216 0 0 1 91.613867 0c25.258667 25.122133 25.258667 65.9456 0 91.136l-70.314667 70.0416z"
      fill="#595959"
    /></svg
  >
  <svg
    on:click={reduction}
    viewBox="0 0 1227 1024"
    version="1.1"
    xmlns="http://www.w3.org/2000/svg"
    width="14"
    height="14"
    ><path
      d="M836.039486 836.040099c-69.030783 46.020522-145.731653 72.835146-226.298248 69.030784H567.58644c-7.670087 0-15.340174-3.865724-23.010261-3.865724-3.865724 0-11.535811-3.804363-15.340174-3.804363A55.224627 55.224627 0 0 1 506.225744 889.730709c-3.865724 0-7.670087-3.865724-11.535811-3.865724a71.546572 71.546572 0 0 0-26.814624-7.670087c-3.865724 0-3.865724 0-7.670087-3.804363a114.805863 114.805863 0 0 1-30.680349-15.340174 376.079707 376.079707 0 0 1-88.236681-65.226421 167.821504 167.821504 0 0 1-23.010261-26.814624 13.560714 13.560714 0 0 1-3.804363-7.670087A377.491003 377.491003 0 0 1 230.102611 517.762168h103.515494l-168.680554-245.442785L0 517.762168h103.576855a515.429848 515.429848 0 0 0 92.041045 291.463307 3.743002 3.743002 0 0 0 3.804363 3.804363c7.670087 7.670087 11.535811 15.340174 19.205898 23.010261 3.804363 3.865724 3.804363 7.670087 7.670087 7.670087a114.928584 114.928584 0 0 0 30.680348 30.680349l3.804363 3.865723c34.546072 34.484711 72.835146 61.360696 115.051305 88.175321h3.865724a353.253528 353.253528 0 0 0 38.350435 19.205898 13.560714 13.560714 0 0 1 7.670087 3.804363l34.484712 11.535811c3.865724 0 11.535811 3.804363 15.340174 3.804363 11.47445 3.865724 19.144537 3.865724 30.680348 7.670087 7.670087 0 11.535811 3.865724 19.144537 3.865724h7.670087c11.535811 0 19.205898 3.804363 26.875985 3.804363h11.47445c15.340174 0 34.546072 3.865724 49.886246 3.865724a496.530754 496.530754 0 0 0 291.463307-92.041044 61.360696 61.360696 0 0 0 15.340174-84.370958c-26.875985-23.010261-65.22642-30.680348-92.041044-11.535811z m287.597583-318.339291a520.215982 520.215982 0 0 0-88.17532-287.597584 3.804363 3.804363 0 0 0-3.865724-3.865723c-7.670087-11.47445-15.340174-19.144537-23.010261-30.680349a3.743002 3.743002 0 0 0-3.804364-3.804363A532.979007 532.979007 0 0 0 813.029225 49.825499c-3.865724 0-3.865724 0-7.670087-3.804363l-34.546072-11.535811c-3.804363 0-7.670087-3.804363-11.47445-3.804363a265.937257 265.937257 0 0 0-30.680349-11.535811c-7.670087 0-11.47445-3.804363-19.205897-3.804363-3.804363 0-3.804363 0-7.670087-3.865724-7.670087 0-15.340174-3.804363-23.010262-3.804363a23.010261 23.010261 0 0 1-15.340174-3.865724 158.310596 158.310596 0 0 1-42.154798-3.804363H613.606962a505.05989 505.05989 0 0 0-291.463307 92.041044c-30.680348 26.875985-34.546072 65.22642-15.340174 92.041044a61.360696 61.360696 0 0 0 84.370957 15.340174 393.690227 393.690227 0 0 1 226.298248-69.030783h46.020522c7.670087 3.865724 15.340174 3.865724 26.814624 7.670087a14.051599 14.051599 0 0 1 11.535811 3.865724c7.670087 3.804363 19.144537 3.804363 26.814624 7.608726 3.865724 0 3.865724 0 7.670088 3.865724 11.535811 3.804363 19.205898 7.670087 30.680348 11.47445h3.865723A346.442491 346.442491 0 0 1 916.60608 276.123747c53.690609 69.030783 88.17532 153.401741 88.17532 245.442784h-103.515494l164.876191 245.442785L1227.213924 517.762168h-103.576855"
      fill="#595959"
    /></svg
  >
  <Pen {changePenSize} />
  <svg
    viewBox="0 0 1024 1024"
    version="1.1"
    xmlns="http://www.w3.org/2000/svg"
    width="14"
    height="14"
    ><path
      d="M980.9 424.1c12.5-12.5 12.5-32.8 0-45.3L636.7 34.6c-12.5-12.5-32.8-12.5-45.3 0L90.5 535.5c-50 50-50 131 0 181l272 270.3c24 23.8 56.4 37.2 90.2 37.2H864c17.7 0 32-14.3 32-32 0-8.8-3.6-16.8-9.4-22.6-5.8-5.8-13.8-9.4-22.6-9.4H599.5c-57 0-85.6-68.9-45.3-109.3l426.7-426.6zM434.8 879.7c-25 25-65.5 25-90.5 0L135.8 671.3c-25-25-25-65.5 0-90.5l127.9-127.9 299 299-127.9 127.8z"
      fill="#595959"
    /></svg
  >
  <svg
    on:click={bigger}
    viewBox="0 0 1024 1024"
    version="1.1"
    xmlns="http://www.w3.org/2000/svg"
    width="14"
    height="14"
  >
    <path
      d="M970.837333 919.850667l-205.696-205.653334A382.421333 382.421333 0 0 0 853.333333 469.333333a384 384 0 0 0-384-384 384 384 0 0 0-384 384 384 384 0 0 0 384 384 382.421333 382.421333 0 0 0 244.906667-88.192l205.653333 205.653334a36.053333 36.053333 0 0 0 50.986667 0 36.266667 36.266667 0 0 0-0.042667-50.944z m-380.117333-162.986667c-38.4 16.256-79.189333 24.448-121.386667 24.448a311.296 311.296 0 0 1-220.586666-91.392A311.296 311.296 0 0 1 157.312 469.333333 311.296 311.296 0 0 1 248.746667 248.746667 311.296 311.296 0 0 1 469.333333 157.354667a311.296 311.296 0 0 1 220.586667 91.392A311.296 311.296 0 0 1 781.354667 469.333333a311.296 311.296 0 0 1-91.392 220.586667 310.186667 310.186667 0 0 1-99.242667 66.901333z"
      fill="#595959"
    />
    <path
      d="M652.672 431.829333h-147.84V292.010667a35.968 35.968 0 1 0-71.978667 0v139.818666H292.010667a35.968 35.968 0 1 0 0 72.021334h140.8v140.8a35.968 35.968 0 1 0 72.021333 0v-140.8h147.84a35.968 35.968 0 1 0 0-72.021334z"
      fill="#595959"
    />
  </svg>
  <svg
    on:click={smaller}
    viewBox="0 0 1024 1024"
    version="1.1"
    xmlns="http://www.w3.org/2000/svg"
    width="14"
    height="14"
  >
    <path
      d="M970.837333 919.850667l-205.696-205.653334A382.421333 382.421333 0 0 0 853.333333 469.333333a384 384 0 0 0-384-384 384 384 0 0 0-384 384 384 384 0 0 0 384 384 382.421333 382.421333 0 0 0 244.906667-88.192l205.653333 205.653334a36.053333 36.053333 0 0 0 50.986667 0 36.266667 36.266667 0 0 0-0.042667-50.944z m-380.117333-162.986667c-38.4 16.256-79.189333 24.448-121.386667 24.448a311.296 311.296 0 0 1-220.586666-91.392A311.296 311.296 0 0 1 157.312 469.333333 311.296 311.296 0 0 1 248.746667 248.746667 311.296 311.296 0 0 1 469.333333 157.354667a311.296 311.296 0 0 1 220.586667 91.392A311.296 311.296 0 0 1 781.354667 469.333333a311.296 311.296 0 0 1-91.392 220.586667 310.186667 310.186667 0 0 1-99.242667 66.901333z"
      fill="#595959"
    />
    <path
      d="M652.672 431.829333H292.010667a35.968 35.968 0 1 0 0 72.021334h360.661333a35.968 35.968 0 1 0 0-72.021334z"
      fill="#595959"
    />
  </svg>
  <svg
    on:click={() => (canvas.isDrawingMode = false)}
    viewBox="0 0 1024 1024"
    version="1.1"
    xmlns="http://www.w3.org/2000/svg"
    width="14"
    height="14"
    ><path
      d="M476.5 924V100c0-19.8 16.2-36 36-36s36 16.2 36 36v824c0 19.8-16.2 36-36 36s-36-16.2-36-36z"
      fill="#595959"
    /><path
      d="M100.5 476h824c19.8 0 36 16.2 36 36s-16.2 36-36 36h-824c-19.8 0-36-16.2-36-36s16.2-36 36-36zM690.1 797.6L538.4 949.3c-14.3 14.3-37.4 14.3-51.7 0L334.2 796.8c-14.3-14.3-14.6-37.9 0-52 14.1-13.5 36.5-13.4 50.4 0.5l117.6 117.6c5.8 5.8 15.1 5.8 20.8 0l115.6-115.6c14.3-14.3 37.9-14.6 52 0 13.5 14.1 13.4 36.5-0.5 50.3zM333.7 226.4L485.4 74.7c14.3-14.3 37.4-14.3 51.7 0l152.5 152.5c14.3 14.3 14.6 37.9 0 52-14.1 13.5-36.5 13.4-50.4-0.5L521.6 161.1c-5.8-5.8-15.1-5.8-20.8 0L385.1 276.7c-14.3 14.3-37.9 14.6-52 0-13.4-14.1-13.3-36.5 0.6-50.3z"
      fill="#595959"
    /><path
      d="M226.7 690.1L75.1 538.4c-14.3-14.3-14.3-37.4 0-51.7l152.5-152.5c14.3-14.3 37.9-14.6 52 0 13.5 14.1 13.4 36.5-0.5 50.4L161.5 502.2c-5.8 5.8-5.8 15.1 0 20.8l115.6 115.6c14.3 14.3 14.6 37.9 0 52-14.1 13.5-36.5 13.4-50.4-0.5zM798.1 333.7l151.7 151.7c14.3 14.3 14.3 37.4 0 51.7L797.3 689.6c-14.3 14.3-37.9 14.6-52 0-13.5-14.1-13.4-36.5 0.5-50.4l117.6-117.6c5.8-5.8 5.8-15.1 0-20.8L747.8 385.1c-14.3-14.3-14.6-37.9 0-52 14.1-13.4 36.5-13.3 50.3 0.6z"
      fill="#595959"
    /></svg
  >
  <svg
    on:click={show}
    viewBox="0 0 1024 1024"
    version="1.1"
    xmlns="http://www.w3.org/2000/svg"
    width="14"
    height="14"
    ><path
      d="M512 274C303.3 274 64 526 64 526s239.3 252 448 252 448-252 448-252-239.3-252-448-252z m0 420c-92.7 0-168-75.2-168-168 0-92.7 75.3-168 168-168 92.8 0 168 75.3 168 168 0 92.8-75.2 168-168 168z m0-56c-61.8 0-112-50.2-112-112s50.2-112 112-112 112 50.2 112 112-50.2 112-112 112z"
      fill="#595959"
    /></svg
  >
</div>

<style>
  .control-wrapper {
    display: flex;
    align-items: center;
    gap: 10px;
    position: absolute;
    bottom: -50px;
    right: 80px;
    background: rgba(37, 43, 47, 1);
    padding: 8px 12px;
    border-radius: 4px;
    user-select: none;
  }
  svg {
    cursor: pointer;
  }
</style>
